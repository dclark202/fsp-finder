<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FSP Finder - Upload</title>
    <link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css" type="text/css">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="{{ request.url_for('static', path='favicon.png') }}">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CZKZ8Q5K0L"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CZKZ8Q5K0L');
    </script>
</head>
<body>
    <header>
        <b style="font-size: 36px;">FSP Finder</b> &nbsp; <b style="color: #7e7e7e; font-size: 32px;">AI-powered music censoring tool</b>
    </header>

    <hr>

    <h4>How to use:</h4> 
    <ul>
      <li>Upload one or more audio files using the box below. Most common audio formats are accepted (e.g., <code>.mp3</code>, <code>.wav</code>, <code>.flac</code>, etc.)</li>
      <li>Click the <b><code>Process audio</code></b> button to create the transcriptions of the uploaded track(s). You will have a chance to review the edits before applying the censoring.</li>
    </ul>
    
    <p><b><a href="{{ request.url_for('methodology') }}">Read more about how FSP Finder works</a></b></p>

   <form action="/analyze" method="post" enctype="multipart/form-data" class="upload-form" novalidate>
      
      <p>Drag & drop your audio files here or click to browse</p>
      
      <input type="file" name="files" id="file-input" required multiple hidden>
      
      <label for="file-input" class="btn-browse">Browse Files</label>

      <div id="file-list-display">
          <p style="color: #585858">No files uploaded yet</p>
      </div>

      <div class="collapsible">
          <button type="button" class="collapsible-toggle">Advanced options (click to open)</button>
          <div class="collapsible-content">
              <label for="profanity-list">Additional words to automatically flag</label>
              <textarea id="profanity-list" name="profanity_list" rows="3" placeholder="Enter words separated by commas (not case sensitive)&#10;&#10;ex.: dang, heck, shucks, ... "></textarea>
              
              <label for="use-vad">Use Voice Activity Detection (VAD) (recommended)</label>
              <input type="checkbox" id="use-vad" name="use_vad" value="true" checked>
              <small>Improves transcription by removing silence and non-speech sections from the vocals stem. Try disabling if you detect large portions of vocals are missing transcriptions.</small>
              
              <label for="llm-detection">Enable LLM content analysis</label>
              <input type="checkbox" id="llm-detection" name="llm_detection" value="true" disabled>
              <small>(Experimental) Uses a large language model to flag additional case dependent explicit content. <b>Selecting this will increase processing times -- currently disabled</b></small>
          </div>
      </div>

      <br>
      <button type="submit" class="process-button">Process audio</button>
    </form>
    
    <br>


    <p><b>Please note</b>: By using this tool, you are agreeing to our <a href="{{ request.url_for('terms') }}">Terms of service</a></p>


    <hr>
    <h5>Recent updates</h5>
        <ul>
            <li><b>30 Oct. 2025</b>: Added file format menu for downloads</li>
        </ul>
    

    <div id="loading-overlay" class="hidden">
        <div class="loading-box">
            <h2 id="loading-text">Processing...</h2>
            <p>
                Please keep this page open
                
                <br>
                
                This may take several minutes based on song length and number of tracks being processed
            </p>
        </div>
    </div>

    <footer>
        <hr>
        <p>
            &copy; 2025 FSP Finder | 
            <a href="https://github.com/dclark202/fsp-finder">View project on GitHub</a> |
            <a href="{{ request.url_for('contact') }}">Contact us</a> |
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSdOvdQDE3ZMhtWG9QhkJ7ysQgn9BuiAUIRzyDL8rpWX0w_DhA/viewform?usp=sharing&ouid=104381324099973996341">Join the mailing list</a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Get references to all the HTML elements ---
            const uploadForm = document.querySelector('.upload-form');
            const fileInput = document.getElementById('file-input');
            const fileListDisplay = document.getElementById('file-list-display');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');

            // --- Store files in an array to allow removal ---
            let stagedFiles = [];

            // --- Function to update the file list UI ---
            const updateFileList = () => {
                fileListDisplay.innerHTML = ''; // Clear the current list

                if (stagedFiles.length === 0) {
                    fileListDisplay.innerHTML = '<p style="color: #585858">No files uploaded yet</p>';
                    return;
                }

                const list = document.createElement('ul');
                stagedFiles.forEach((file, index) => {
                    const listItem = document.createElement('li');
                    
                    // File name text node
                    const fileName = document.createTextNode(file.name);

                    // Create remove button "x"
                    const removeBtn = document.createElement('button');
                    removeBtn.type = "button"; // prevent form submission
                    removeBtn.className = "remove-file-btn";
                    removeBtn.textContent = 'x';
                    removeBtn.title = `Remove ${file.name}`;
                    
                    // Add click event to remove the file from the array and re-render the list
                    removeBtn.onclick = () => removeFile(index);

                    listItem.appendChild(fileName);
                    listItem.appendChild(removeBtn);
                    list.appendChild(listItem);
                });
                fileListDisplay.appendChild(list);
            };
            
            // --- Helper function to add new files to the staged list ---
            const addFiles = (newFiles) => {
                for (const file of newFiles) {
                    // Optional: check for duplicates before adding
                    if (!stagedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        stagedFiles.push(file);
                    }
                }
                updateFileList();
            };

            // --- Helper function to remove a file by index ---
            const removeFile = (indexToRemove) => {
                stagedFiles.splice(indexToRemove, 1);
                updateFileList();
            };

            // --- EVENT LISTENERS TO UPDATE THE FILE LIST ---
            uploadForm.addEventListener('dragover', (e) => { e.preventDefault(); uploadForm.classList.add('drag-over'); });
            uploadForm.addEventListener('dragleave', () => uploadForm.classList.remove('drag-over'));
            uploadForm.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadForm.classList.remove('drag-over');
                addFiles(e.dataTransfer.files); // Use addFiles helper
            });
            fileInput.addEventListener('change', () => addFiles(fileInput.files)); // Use addFiles helper

            // --- LOGIC FOR SUBMITTING THE FORM AND POLLING FOR RESULTS ---
            uploadForm.addEventListener('submit', (event) => {
                event.preventDefault();
                if (stagedFiles.length === 0) {
                    alert("Please upload at least one audio file.");
                    return;
                }

                loadingText.textContent = 'Uploading...';
                loadingOverlay.classList.remove('hidden');
                
                // Build FormData manually and include advanced options
                const formData = new FormData();
                stagedFiles.forEach(file => {
                    formData.append('files', file);
                });

                // Get advanced options and append them to the form data
                const profanityList = document.getElementById('profanity-list').value;
                const useVad = document.getElementById('use-vad').checked;
                const llmDetection = document.getElementById('llm-detection').checked;

                formData.append('profanity_list', profanityList);
                formData.append('use_vad', useVad);
                formData.append('llm_detection', llmDetection);

                fetch('/analyze', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.job_ids && data.job_ids.length > 0) {
                        loadingText.textContent = 'Processing... (0/' + data.job_ids.length + ' complete)';
                        waitForAllJobs(data.job_ids);
                    } else { throw new Error("Server did not return job IDs."); }
                })
                .catch(error => {
                    console.error('Upload Error:', error);
                    loadingOverlay.classList.add('hidden');
                    alert('An error occurred during upload.');
                });
            });

            const waitForAllJobs = (jobIds) => {
                let completedCount = 0;
                let jobStatuses = {}; // Object to track individual job statuses
                jobIds.forEach(id => jobStatuses[id] = 'submitted');

                const updateLoadingText = () => {
                    const processingJobs = Object.values(jobStatuses).filter(s => s === 'processing').length;
                    const queuedJobs = Object.values(jobStatuses).filter(s => s === 'queued').length;

                    if (processingJobs > 0) {
                        loadingText.textContent = `Processing... (${completedCount}/${jobIds.length} complete)`;
                    } else if (queuedJobs > 0) {
                        loadingText.textContent = `Your job is in the queue... (${completedCount}/${jobIds.length} complete)`;
                    } else {
                        loadingText.textContent = `Finalizing... (${completedCount}/${jobIds.length} complete)`;
                    }
                };

                const checkPromises = jobIds.map(jobId => {
                    return new Promise((resolve, reject) => {
                        const interval = setInterval(() => {
                            fetch(`/status/${jobId}`)
                                .then(res => res.json())
                                .then(data => {
                                    jobStatuses[jobId] = data.status; // Update status
                                    updateLoadingText(); // Update UI text

                                    if (data.status === 'complete') {
                                        clearInterval(interval);
                                        completedCount++;
                                        updateLoadingText();
                                        resolve(jobId);
                                    } else if (data.status === 'failed') {
                                        clearInterval(interval);
                                        reject(new Error(`Job ${jobId} failed`));
                                    }
                                });
                        }, 5000); // Check every 5 seconds
                    });
                });

                Promise.all(checkPromises)
                    .then((completedJobIds) => {
                        const jobIdsString = completedJobIds.join(',');
                        window.location.href = `/results?job_ids=${jobIdsString}`;
                    })
                    .catch(error => {
                        console.error("A job failed:", error);
                        loadingOverlay.classList.add('hidden');
                        alert("One or more processing jobs failed. Please check the console and try again.");
                    });
            };
            
            // --- ADVANCED OPTIONS COLLAPSIBLE SCRIPT ---
            document.querySelector('.collapsible-toggle').addEventListener('click', function() {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
            });
        });
        
    </script>
</body>
</html>